name: Build WaffleCopyPRO on Ubuntu

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version:	    5.15.2
          host:		    linux
          target: 	    desktop
          arch:      	gcc_64
          dir:          ${{ runner.temp }}
          setup-python: false
          
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libgl1-mesa-dev
          sudo apt-get install -y patchelf # Required by linuxdeployqt

      - name: Build Project
        run: |
          cd waffleCopyPRO-Universal
          qmake waffleCopyPRO-Universal.pro
          make -j$(nproc)

      - name: Install linuxdeployqt
        run: |
          mkdir -p /tmp/linuxdeployqt
          wget -c -nv https://github.com/probonopd/linuxdeployqt/releases/download/7/linuxdeployqt-7-x86_64.AppImage -O /tmp/linuxdeployqt/linuxdeployqt.AppImage
          chmod a+x /tmp/linuxdeployqt/linuxdeployqt.AppImage
          cd /tmp/linuxdeployqt # Change directory before extracting
          ./linuxdeployqt.AppImage --appimage-extract # This extracts to squashfs-root in /tmp/linuxdeployqt
          
          echo "/tmp/linuxdeployqt/squashfs-root" >> $GITHUB_PATH

      - name: Deploy and Package
        run: |
          cd waffleCopyPRO-Universal
          mkdir release
          # Use linuxdeployqt to deploy Qt dependencies
          /tmp/linuxdeployqt/squashfs-root/AppRun waffleCopyPRO-Universal -appimage -bundle-non-qt-libs -verbose=2
          
          # Copy additional assets
          cp -r fonts release/
          cp -r WaffleUI release/
          
          # Create zip archive
          zip -r ../waffleCopyPRO-Universal-Linux-amd64.zip release/

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: waffleCopyPRO-Universal-Linux-amd64
          path: waffleCopyPRO-Universal-Linux-amd64.zip

      - name: Upload Release Asset
        if: github.event_name == 'release' && github.event.action == 'published'
        uses: softprops/action-gh-release@v1
        with:
          files: waffleCopyPRO-Universal-Linux-amd64.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}