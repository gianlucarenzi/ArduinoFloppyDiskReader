name: Build WaffleCopyPRO on macOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '5.15.2'
        arch: 'clang_64'

    - name: Install x86_64 Homebrew
      run: |
        arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    - name: Install dependencies
      run: |
        arch -x86_64 /usr/local/bin/brew install libmikmod

    - name: Build waffleCopyPRO-Universal
      run: |
        cd waffleCopyPRO-Universal
        qmake
        make

    - name: Package Application and Resources
      run: |
        cd waffleCopyPRO-Universal
        macdeployqt waffleCopyPRO-Universal.app
        echo "Copying resource folders to Contents/Resources..."
        cp -R fonts waffleCopyPRO-Universal.app/Contents/Resources/
        cp -R WaffleUI waffleCopyPRO-Universal.app/Contents/Resources/

        # Frameworks folder (no CAPSImage.framework copying; CAPS integrated statically)
        mkdir -p waffleCopyPRO-Universal.app/Contents/Frameworks

        # Add rpath to executables so they find the Frameworks folder
        for exe in waffleCopyPRO-Universal.app/Contents/MacOS/*; do
          [ -f "$exe" ] || continue
          install_name_tool -add_rpath "@executable_path/../Frameworks" "$exe" || true
        done

    - name: Ensure Info.plist has bundle name
      run: |
        cd waffleCopyPRO-Universal
        PLIST=waffleCopyPRO-Universal.app/Contents/Info.plist
        if [ -f "$PLIST" ]; then
          /usr/libexec/PlistBuddy -c "Print :CFBundleName" "$PLIST" >/dev/null 2>&1 && /usr/libexec/PlistBuddy -c "Set :CFBundleName 'waffleCopyPRO-Universal'" "$PLIST" || /usr/libexec/PlistBuddy -c "Add :CFBundleName string 'waffleCopyPRO-Universal'" "$PLIST"
          /usr/libexec/PlistBuddy -c "Print :CFBundleDisplayName" "$PLIST" >/dev/null 2>&1 && /usr/libexec/PlistBuddy -c "Set :CFBundleDisplayName 'WaffleCopyPRO'" "$PLIST" || /usr/libexec/PlistBuddy -c "Add :CFBundleDisplayName string 'WaffleCopyPRO'" "$PLIST"
        else
          echo "Info.plist not found at $PLIST"
        fi

    - name: Generate DMG background
      run: |
        mkdir -p assets
        python3 -m pip install --user pillow
        python3 - <<'PY'
        from PIL import Image, ImageDraw
        w,h=540,380
        img=Image.new('RGB',(w,h),(60,80,120))
        draw=ImageDraw.Draw(img)
        for i in range(h):
            r=int(60 + (i*(180-60)/h))
            g=int(80 + (i*(220-80)/h))
            b=int(120 + (i*(255-120)/h))
            draw.line([(0,i),(w,i)], fill=(r,g,b))
        draw.text((20,h-40),"waffleCopyPRO", fill=(255,255,255))
        img.save("assets/dmg-background.png")
        PY

    - name: Create DMG Installer (hdiutil)
      run: |
        cd waffleCopyPRO-Universal
        mkdir -p ../release
        DMG_TMP="../release/waffleCopyPRO_tmp.dmg"
        VOL_NAME="WaffleCopyPRO"
        SRC_DIR="../release/dmg_src"
        rm -rf "$SRC_DIR" "$DMG_TMP" ../release/waffleCopyPRO-Universal.dmg
        mkdir -p "$SRC_DIR"
        # Copy app and resources into source folder
        cp -R waffleCopyPRO-Universal.app "$SRC_DIR"/
        mkdir -p "$SRC_DIR"/.background
        cp ../assets/dmg-background.png "$SRC_DIR"/.background/background.png
        ln -s /Applications "$SRC_DIR"/Applications
        # Create a writable DMG from source folder
        hdiutil create -srcfolder "$SRC_DIR" -fs HFS+ -volname "$VOL_NAME" -ov -format UDRW "$DMG_TMP"
        # Attach it
        hdiutil attach "$DMG_TMP" -mountpoint /Volumes/"$VOL_NAME" -nobrowse -noverify || true
        sleep 2
        # Configure Finder window appearance and icon positions
        osascript <<APPLESCRIPT
        tell application "Finder"
          tell disk "$VOL_NAME"
            open
            set current view of container window to icon view
            set toolbar visible of container window to false
            set statusbar visible of container window to false
            set the bounds of container window to {100, 100, 640, 480}
            set viewOptions to the icon view options of container window
            set arrangement of viewOptions to not arranged
            set icon size of viewOptions to 128
            set background picture of viewOptions to file ".background:background.png"
            set position of item "waffleCopyPRO-Universal.app" of container window to {140, 190}
            set position of item "Applications" of container window to {400, 190}
            close
            open
            update without registering applications
            delay 2
          end tell
        end tell
        APPLESCRIPT
        # Detach and convert to compressed read-only DMG
        hdiutil detach /Volumes/"$VOL_NAME"
        hdiutil convert "$DMG_TMP" -format UDZO -imagekey zlib-level=9 -o ../release/waffleCopyPRO-Universal.dmg
        rm -f "$DMG_TMP"
        rm -rf "$SRC_DIR"
        mv ../release/waffleCopyPRO-Universal.dmg ../waffleCopyPRO-Universal.dmg

    - name: Upload DMG Artifact
      uses: actions/upload-artifact@v4
      with:
        name: waffleCopyPRO-Universal-macOS.dmg
        path: waffleCopyPRO-Universal.dmg

    - name: Create Release and Upload Asset
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: waffleCopyPRO-Universal.dmg
        draft: false
        prerelease: false
