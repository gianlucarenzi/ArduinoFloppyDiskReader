name: Build WaffleCopyPRO on macOS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: '5.15.2'
        arch: 'clang_64'

    - name: Install x86_64 Homebrew
      run: |
        arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    - name: Install dependencies
      run: |
        arch -x86_64 /usr/local/bin/brew install libmikmod

    - name: Build waffleCopyPRO-Universal
      run: |
        cd waffleCopyPRO-Universal
        qmake
        make

    - name: Package Application and Resources
      run: |
        cd waffleCopyPRO-Universal
        macdeployqt waffleCopyPRO-Universal.app
        echo "Copying resource folders to Contents/Resources..."
        cp -R fonts waffleCopyPRO-Universal.app/Contents/Resources/
        cp -R WaffleUI waffleCopyPRO-Universal.app/Contents/Resources/

    - name: Generate DMG background
      run: |
        mkdir -p assets
        python3 -m pip install --user pillow
        python3 - <<'PY'
        from PIL import Image, ImageDraw
        w,h=540,380
        img=Image.new('RGB',(w,h),(60,80,120))
        draw=ImageDraw.Draw(img)
        for i in range(h):
            r=int(60 + (i*(180-60)/h))
            g=int(80 + (i*(220-80)/h))
            b=int(120 + (i*(255-120)/h))
            draw.line([(0,i),(w,i)], fill=(r,g,b))
        draw.text((20,h-40),"waffleCopyPRO", fill=(255,255,255))
        img.save("assets/dmg-background.png")
        PY

    - name: Install create-dmg
      run: |
        npm install -g create-dmg

    - name: Create DMG Installer
      run: |
        mkdir -p release
        create-dmg "waffleCopyPRO-Universal/waffleCopyPRO-Universal.app" --overwrite --out release --background "assets/dmg-background.png" --icon-size 128 --window-size 540 380 --icon "waffleCopyPRO-Universal.app" 140 190 --icon "Applications" 400 190
        mv release/*.dmg waffleCopyPRO-Universal.dmg

    - name: Upload DMG Artifact
      uses: actions/upload-artifact@v4
      with:
        name: waffleCopyPRO-Universal-macOS.dmg
        path: waffleCopyPRO-Universal.dmg

    - name: Create Release and Upload Asset
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: waffleCopyPRO-Universal.dmg
        draft: false
        prerelease: false
