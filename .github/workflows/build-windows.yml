name: Build WaffleCopyPRO on Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4


      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version:      5.15.2
          host:        windows
          target:       desktop
          arch:        win64_msvc2019_64
          dir:          ${{ runner.temp }}
          setup-python: false

      - name: Install vcpkg
        shell: cmd
        run: |
          if not exist vcpkg git clone --branch 2025.12.12 https://github.com/microsoft/vcpkg.git
          if exist vcpkg ( .\vcpkg\bootstrap-vcpkg.bat )

      - name: Install libmikmod (vcpkg)
        shell: cmd
        run: |
          .\vcpkg\vcpkg install libmikmod:x64-windows

      - name: Build Project
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          cd waffleCopyPRO-Universal
          qmake -tp vc waffleCopyPRO-Universal.pro
          msbuild waffleCopyPRO-Universal.vcxproj /p:Configuration=Release /p:Platform=x64

      - name: Deploy and prepare release folder
        run: |
          $ROOT = "${{ github.workspace }}"
          $RELEASE_DIR = "waffleCopyPRO-Universal/release"
          New-Item -ItemType Directory -Path $RELEASE_DIR -Force -ErrorAction SilentlyContinue | Out-Null
          & "${{ env.Qt5_Dir }}\bin\windeployqt.exe" `
            --force `
            --no-translations `
            --dir $RELEASE_DIR `
            "$RELEASE_DIR\waffleCopyPRO-Universal.exe" || true

          # List release dir for debugging missing-runtime issues
          Get-ChildItem -Path $RELEASE_DIR -Recurse | Select-Object FullName -First 200

          $VCPKG_BIN = "$ROOT\vcpkg\installed\x64-windows\bin"
          if (Test-Path $VCPKG_BIN) {
              Copy-Item "$VCPKG_BIN\*.dll" $RELEASE_DIR -Force -ErrorAction SilentlyContinue
          }

          # Attempt to copy MSVC runtime from Visual Studio Redist (try multiple locations)
          $MSVC_REDIST = Get-ChildItem `
            "C:\Program Files (x86)\Microsoft Visual Studio\2019" -Recurse -Directory -ErrorAction SilentlyContinue | Where-Object { $_.FullName -like '*Redist\\MSVC*' } | Sort-Object Name -Descending | Select-Object -First 1
          if ($MSVC_REDIST) {
              $CRT_PATH = Join-Path $MSVC_REDIST.FullName "x64\Microsoft.VC142.CRT"
              if (Test-Path $CRT_PATH) {
                  Copy-Item "$CRT_PATH\*.dll" $RELEASE_DIR -Force -ErrorAction SilentlyContinue
              } else {
                  # fallback: search for Microsoft.VC142.CRT dirs under VS installs
                  $crtDirs = Get-ChildItem -Path 'C:\Program Files (x86)\Microsoft Visual Studio\2019' -Recurse -Directory -ErrorAction SilentlyContinue | Where-Object { $_.Name -eq 'Microsoft.VC142.CRT' }
                  foreach ($d in $crtDirs) {
                      Copy-Item "$(Join-Path $d.FullName '*.dll')" $RELEASE_DIR -Force -ErrorAction SilentlyContinue
                  }
              }
          } else {
              # final fallback: try to find vcruntime140_1.dll under WinSxS and copy any matches
              $possible = Get-ChildItem -Path 'C:\Windows\WinSxS' -Filter 'vcruntime140_1.dll' -Recurse -ErrorAction SilentlyContinue -Force
              foreach ($p in $possible) {
                  Copy-Item $p.FullName $RELEASE_DIR -Force -ErrorAction SilentlyContinue
              }
          }

          # Ensure specific MSVC runtime DLLs are present in release for Wine or portable installs
          $runtimeNames = @('msvcp140_1.dll','vcruntime140_1.dll','msvcp140.dll','vcruntime140.dll')
          foreach ($name in $runtimeNames) {
              $found = Get-ChildItem -Path 'C:\Program Files (x86)\Microsoft Visual Studio\2019' -Recurse -Filter $name -ErrorAction SilentlyContinue -Force | Select-Object -ExpandProperty FullName -ErrorAction SilentlyContinue
              if (!$found) {
                  $found = Get-ChildItem -Path 'C:\Windows\WinSxS' -Recurse -Filter $name -ErrorAction SilentlyContinue -Force | Select-Object -ExpandProperty FullName -ErrorAction SilentlyContinue
              }
              if (!$found) {
                  $sys = Join-Path $env:SystemRoot $name
                  if (Test-Path $sys) { $found = $sys }
              }
              foreach ($f in @($found)) {
                  if ($f -and (Test-Path $f)) { Copy-Item $f $RELEASE_DIR -Force -ErrorAction SilentlyContinue }
              }
          }

          # Copy CAPS DLLs if provided in repo locations
          $CAPS_PATH1 = Join-Path $ROOT "waffleCopyPRO-Universal\lib\capsapi"
          if (Test-Path $CAPS_PATH1) {
            Copy-Item -Path (Join-Path $CAPS_PATH1 "*.dll") -Destination $RELEASE_DIR -Force -ErrorAction SilentlyContinue
          }
          $CAPS_PATH2 = Join-Path $ROOT "lib\capsapi"
          if (Test-Path $CAPS_PATH2) {
            Copy-Item -Path (Join-Path $CAPS_PATH2 "*.dll") -Destination $RELEASE_DIR -Force -ErrorAction SilentlyContinue
          }
                    
          Copy-Item -Path "waffleCopyPRO-Universal/fonts" -Destination $RELEASE_DIR -Recurse -ErrorAction SilentlyContinue
          Copy-Item -Path "waffleCopyPRO-Universal/WaffleUI" -Destination $RELEASE_DIR -Recurse -ErrorAction SilentlyContinue

          Push-Location $RELEASE_DIR
          Compress-Archive -Path * -DestinationPath "../waffleCopyPRO-Universal-Windows.zip" -Force
          Pop-Location
        shell: pwsh

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup --no-progress -y

      - name: Create Inno Setup Installer
        shell: pwsh
        run: |
          $RELEASE_DIR = "${{ github.workspace }}\waffleCopyPRO-Universal\release"
          $ISS = "${{ github.workspace }}\waffleCopyPRO-Universal\waffleCopyPRO-Universal.iss"
          $OutBase = "waffleCopyPRO-Universal-Setup"
          $appName = "WaffleCopyPRO"
          $appExe = "waffleCopyPRO-Universal.exe"
          $version = "1.0.0"
          $issContent = @"
          [Setup]
          AppName=$appName
          AppVersion=$version
          DefaultDirName={pf}\$appName
          DefaultGroupName=$appName
          DisableProgramGroupPage=no
          OutputBaseFilename=$OutBase
          Compression=lzma
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64
          
          [Files]
          Source: "$RELEASE_DIR\*"; DestDir: "{app}"; Flags: recursesubdirs ignoreversion
          
          [Icons]
          Name: "{group}\$appName"; Filename: "{app}\$appExe"
          Name: "{userdesktop}\$appName"; Filename: "{app}\$appExe"
          
          [Run]
          Filename: "{app}\$appExe"; Description: "Launch $appName"; Flags: nowait postinstall skipifdoesntexist
          "@

          Set-Content -Path $ISS -Value $issContent -Encoding UTF8
          & "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe" $ISS
          Move-Item -Path "${{ github.workspace }}\waffleCopyPRO-Universal\Output\${OutBase}.exe" -Destination "${{ github.workspace }}\waffleCopyPRO-Universal\${OutBase}.exe" -Force

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: waffle-setup
          path: |
            waffleCopyPRO-Universal/waffleCopyPRO-Universal-Setup.exe
            waffleCopyPRO-Universal-Windows.zip

      - name: Create Release and Upload Asset
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            waffleCopyPRO-Universal/waffleCopyPRO-Universal-Setup.exe
          draft: false
          prerelease: false

