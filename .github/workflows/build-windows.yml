name: Build WaffleCopyPRO on Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version:      5.15.2
          host:        windows
          target:       desktop
          arch:        win64_msvc2019_64
          dir:          ${{ runner.temp }}
          setup-python: false

      - name: Install vcpkg
        shell: cmd
        run: |
          git clone --branch 2025.12.12 https://github.com/microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat

      - name: Install libmikmod (vcpkg)
        shell: cmd
        run: |
          .\vcpkg\vcpkg install libmikmod:x64-windows

      - name: Build Project
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          cd waffleCopyPRO-Universal
          qmake -tp vc "INCLUDEPATH+=${{ env.VCPKG_ROOT }}\\installed\\x64-windows\\include" "LIBS+=-L${{ env.VCPKG_ROOT }}\\installed\\x64-windows\\lib -lmikmod" waffleCopyPRO-Universal.pro
          msbuild waffleCopyPRO-Universal.vcxproj /p:Configuration=Release /p:PlatformToolset=v143

      - name: Deploy and Package
        run: |
          $ROOT = "${{ github.workspace }}"
          $RELEASE_DIR = "waffleCopyPRO-Universal/release"
          if (-not (Test-Path $RELEASE_DIR)) { New-Item -ItemType Directory -Path $RELEASE_DIR -Force | Out-Null }

          & "${{ env.Qt5_Dir }}\bin\windeployqt.exe" `
            --force `
            --no-translations `
            --dir $RELEASE_DIR `
            "$RELEASE_DIR\waffleCopyPRO-Universal.exe" || true

          # Copy vcpkg-installed dlls (x64)
          $VCPKG_BIN = "$ROOT\vcpkg\installed\x64-windows\bin"
          if (Test-Path $VCPKG_BIN) {
            Copy-Item "$VCPKG_BIN\*.dll" $RELEASE_DIR -Force -ErrorAction SilentlyContinue
          }

          # Prefer VS Redist x64 CRT path, then WinSxS, then download+extract vc_redist
          $CRT_COPIED = $false
          $MSVC_BASE = "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Redist\MSVC"
          if (Test-Path $MSVC_BASE) {
            $MSVC_REDIST = Get-ChildItem $MSVC_BASE -Directory | Sort-Object Name -Descending | Select-Object -First 1
            if ($MSVC_REDIST) {
              $CRT_PATH = Join-Path $MSVC_REDIST.FullName "x64\Microsoft.VC143.CRT"
              if (Test-Path $CRT_PATH) {
                Copy-Item "$CRT_PATH\*.dll" $RELEASE_DIR -Force -ErrorAction SilentlyContinue
                $CRT_COPIED = $true
              }
            }
          }

          if (-not $CRT_COPIED) {
            $winSxS = Get-ChildItem "C:\Windows\WinSxS" -Filter "*Microsoft.VC143.CRT*" -Directory -ErrorAction SilentlyContinue
            foreach ($d in $winSxS) {
              $possible = Join-Path $d.FullName "x64"
              if (Test-Path $possible) {
                Copy-Item "$possible\*.dll" $RELEASE_DIR -Force -ErrorAction SilentlyContinue
                $CRT_COPIED = $true
                break
              }
            }
          }

          if (-not $CRT_COPIED) {
            $vc = "$env:TEMP\vc_redist.x64.exe"
            Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile $vc -UseBasicParsing -ErrorAction SilentlyContinue
            if (Test-Path $vc) {
              $extractDir = Join-Path $env:TEMP "vc_redist_extracted"
              if (Test-Path $extractDir) { Remove-Item $extractDir -Recurse -Force -ErrorAction SilentlyContinue }
              New-Item -ItemType Directory -Path $extractDir | Out-Null
              $sevenZip = "C:\Program Files\7-Zip\7z.exe"
              if (Test-Path $sevenZip) {
                & $sevenZip x $vc -o$extractDir -y | Out-Null
              } else {
                try { Expand-Archive -Path $vc -DestinationPath $extractDir -ErrorAction Stop } catch {}
              }
              $found = Get-ChildItem $extractDir -Recurse -Filter "Microsoft.VC143.CRT" -Directory -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) {
                $possible = Join-Path $found.FullName "x64"
                if (Test-Path $possible) {
                  Copy-Item "$possible\*.dll" $RELEASE_DIR -Force -ErrorAction SilentlyContinue
                  $CRT_COPIED = $true
                }
              }
            }
          }

          # Ensure critical MSVC runtime DLLs are present (for Wine x64)
          $requiredDlls = @("msvcp140_1.dll","vcruntime140_1.dll")
          foreach ($dll in $requiredDlls) {
            $dest = Join-Path $RELEASE_DIR $dll
            if (-not (Test-Path $dest)) {
              Write-Host "Looking for $dll to copy into release..."
              # Try VS Redist location
              if ($MSVC_REDIST) {
                $tryPath = Join-Path $MSVC_REDIST.FullName (Join-Path "x64\Microsoft.VC143.CRT" $dll)
                if (Test-Path $tryPath) { Copy-Item $tryPath $RELEASE_DIR -Force -ErrorAction SilentlyContinue; continue }
              }
              # Try WinSxS
              $found = Get-ChildItem "C:\Windows\WinSxS" -Filter $dll -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
              if ($found) { Copy-Item $found.FullName $RELEASE_DIR -Force -ErrorAction SilentlyContinue; continue }
              # Try extracted vc_redist payload
              if (Test-Path "$env:TEMP\vc_redist_extracted") {
                $found = Get-ChildItem "$env:TEMP\vc_redist_extracted" -Filter $dll -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
                if ($found) { Copy-Item $found.FullName $RELEASE_DIR -Force -ErrorAction SilentlyContinue; continue }
              }
              Write-Host "Warning: $dll not found in known locations"
            } else {
              Write-Host "$dll already present in release"
            }
          }

          # Copy CAPS DLLs if provided in repo locations
          $CAPS_PATH1 = Join-Path $ROOT "waffleCopyPRO-Universal\lib\capsimg"
          if (Test-Path $CAPS_PATH1) {
            Copy-Item -Path (Join-Path $CAPS_PATH1 "*.dll") -Destination $RELEASE_DIR -Force -ErrorAction SilentlyContinue
          }
          $CAPS_PATH2 = Join-Path $ROOT "lib\capsimg"
          if (Test-Path $CAPS_PATH2) {
            Copy-Item -Path (Join-Path $CAPS_PATH2 "*.dll") -Destination $RELEASE_DIR -Force -ErrorAction SilentlyContinue
          }

          # List release contents and report hashes for key DLLs
          Write-Host "Release directory contents:"; Get-ChildItem $RELEASE_DIR -Recurse | Select-Object FullName, Length | ForEach-Object { Write-Host "$_" }
          foreach ($dll in $requiredDlls) {
            $path = Join-Path $RELEASE_DIR $dll
            if (Test-Path $path) { Write-Host "Found $dll ->"; Get-FileHash $path -Algorithm SHA256 | ForEach-Object { Write-Host $_.Hash } } else { Write-Host "$dll missing in release" }
          }

          Copy-Item -Path "waffleCopyPRO-Universal/fonts" -Destination $RELEASE_DIR -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "waffleCopyPRO-Universal/WaffleUI" -Destination $RELEASE_DIR -Recurse -Force -ErrorAction SilentlyContinue
          Copy-Item -Path "waffleCopyPRO-Universal/translations" -Destination $RELEASE_DIR -Recurse -Force -ErrorAction SilentlyContinue

          # Create a simple PowerShell installer script in repo (optional)
          $installer = @'
          param()
          $src = $PSScriptRoot
          $dest = Join-Path $env:ProgramFiles "WaffleCopyPRO"
          if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest -Force | Out-Null }
          # Copy all files from current folder into destination
          Get-ChildItem -Path $src -Recurse | ForEach-Object {
            $rel = $_.FullName.Substring($src.Length).TrimStart('\','/')
            if ([string]::IsNullOrEmpty($rel)) { return }
            $target = Join-Path $dest $rel
            if ($_.PSIsContainer) {
              if (-not (Test-Path $target)) { New-Item -ItemType Directory -Path $target -Force | Out-Null }
            } else {
              Copy-Item $_.FullName $target -Force -ErrorAction SilentlyContinue
            }
          }
          $WshShell = New-Object -ComObject WScript.Shell
          $shortcutPath = Join-Path $env:ProgramData "Microsoft\Windows\Start Menu\Programs\WaffleCopyPRO.lnk"
          $shortcut = $WshShell.CreateShortcut($shortcutPath)
          $shortcut.TargetPath = Join-Path $dest "waffleCopyPRO-Universal.exe"
          $shortcut.WorkingDirectory = $dest
          $shortcut.Save()
          '@
          Set-Content -Path "waffleCopyPRO-Universal/Install-WaffleCopyPRO.ps1" -Value $installer -Encoding UTF8
        shell: pwsh

      - name: Create ZIP archive
        shell: pwsh
        run: |
          $zipPath = "${{ github.workspace }}\waffleCopyPRO-Universal-Windows.zip"
          if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
          Compress-Archive -Path "waffleCopyPRO-Universal/release/*" -DestinationPath $zipPath -Force

      - name: Create Inno Setup installer
        shell: pwsh
        run: |
          $workspace = "${{ github.workspace }}"
          $zipPath = Join-Path $workspace "waffleCopyPRO-Universal-Windows.zip"
          $buildDir = Join-Path $env:TEMP "wcp_inst_build"
          if (Test-Path $buildDir) { Remove-Item $buildDir -Recurse -Force }
          New-Item -ItemType Directory -Path $buildDir | Out-Null
          Expand-Archive -Path $zipPath -DestinationPath $buildDir -Force

          # Read version from waffleconfig.h
          $configFile = Join-Path $workspace "waffleCopyPRO-Universal\inc\waffleconfig.h"
          $versionLine = Get-Content $configFile | Select-String 'WAFFLE_VERSION\s+"([^"]+)"'
          $appVersion = if ($versionLine) { $versionLine.Matches.Groups[1].Value } else { "2.5.17" }
          Write-Host "Detected version: $appVersion"

          choco install innosetup -y --no-progress || true
          $isccPaths = @("C:\Program Files (x86)\Inno Setup 6\ISCC.exe","C:\Program Files\Inno Setup 6\ISCC.exe")
          $iscc = $isccPaths | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $iscc) { Write-Host "ISCC.exe not found; installer build skipped"; exit 0 }

          # copy icon if available
          $iconCandidate = Join-Path $workspace "waffleCopyPRO-Universal\WaffleUI\Amiga.ico"
          if (-not (Test-Path $iconCandidate)) {
            $iconCandidate = Join-Path $workspace "waffleCopyPRO-Universal\WaffleUI\WaffleCopyPRO-icon.png"
          }
          if (Test-Path $iconCandidate) { Copy-Item $iconCandidate -Destination (Join-Path $buildDir "app.ico") -Force }

          $issPath = Join-Path $buildDir "wcp.iss"
          $iss = @"
          [Setup]
          AppName=WaffleCopyPRO
          AppVersion=$appVersion
          DefaultDirName={pf}\WaffleCopyPRO
          DefaultGroupName=WaffleCopyPRO
          OutputBaseFilename=setup
          Compression=lzma2
          SolidCompression=yes
          SetupIconFile=WaffleUI\Amiga.ico
          UninstallDisplayIcon={app}\WaffleUI\Amiga.ico

          [Files]
          Source: "*"; DestDir: "{app}"; Flags: recursesubdirs createallsubdirs

          [Icons]
          Name: "{group}\WaffleCopyPRO"; Filename: "{app}\waffleCopyPRO-Universal.exe"; IconFilename: "{app}\WaffleUI\Amiga.ico"
          Name: "{commondesktop}\WaffleCopyPRO"; Filename: "{app}\waffleCopyPRO-Universal.exe"; IconFilename: "{app}\WaffleUI\Amiga.ico"; Tasks: desktopicon

          [Tasks]
          Name: "desktopicon"; Description: "Create a &desktop icon"; GroupDescription: "Additional icons:"
          "@
          Set-Content -Path $issPath -Value $iss -Encoding UTF8

          Push-Location $buildDir
          & $iscc $issPath
          Pop-Location

          $foundSetup = Get-ChildItem $buildDir -Recurse -Filter setup.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($foundSetup) { Copy-Item $foundSetup.FullName (Join-Path $buildDir "setup.exe") -Force }

          # Create final ZIP with installer included (overwrite original -Windows zip)
          $finalZip = Join-Path $workspace "waffleCopyPRO-Universal-Windows.zip"
          if (Test-Path $finalZip) { Remove-Item $finalZip -Force }
          $finalDir = Join-Path $workspace "wcp_final"
          if (Test-Path $finalDir) { Remove-Item $finalDir -Recurse -Force }
          New-Item -ItemType Directory -Path $finalDir | Out-Null
          Copy-Item -Path (Join-Path $buildDir "*") -Destination $finalDir -Recurse -Force
          Compress-Archive -Path (Join-Path $finalDir "*") -DestinationPath $finalZip -Force

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: waffleCopyPRO-Universal-Windows
          path: wcp_final/

      - name: Create Release and Upload Asset
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            waffleCopyPRO-Universal-Windows.zip
          draft: false
          prerelease: false

