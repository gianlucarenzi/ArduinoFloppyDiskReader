name: Build WaffleCopyPRO on Windows

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-2019

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version:      5.15.2
          host:        windows
          target:       desktop
          arch:        win64_msvc2019_64
          dir:          ${{ runner.temp }}
          setup-python: false

      - name: Install vcpkg
        shell: cmd
        run: |
          git clone --branch 2025.12.12 https://github.com/microsoft/vcpkg.git
          .\vcpkg\bootstrap-vcpkg.bat

      - name: Install libmikmod (vcpkg)
        shell: cmd
        run: |
          .\vcpkg\vcpkg install libmikmod:x64-windows

      - name: Build Project
        shell: cmd
        env:
          VCPKG_ROOT: ${{ github.workspace }}\vcpkg
        run: |
          call "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" x64
          cd waffleCopyPRO-Universal
          qmake -tp vc waffleCopyPRO-Universal.pro
          msbuild waffleCopyPRO-Universal.vcxproj /p:Configuration=Release

      - name: Deploy and Package
        run: |
          $ROOT = "${{ github.workspace }}"
          $RELEASE_DIR = "waffleCopyPRO-Universal/release"
          & "${{ env.Qt5_Dir }}\bin\windeployqt.exe" `
          --force `
          --no-translations `
          --no-compiler-runtime `
          --dir $RELEASE_DIR `
          "$RELEASE_DIR\waffleCopyPRO-Universal.exe"
          
          $VCPKG_BIN = "$ROOT\vcpkg\installed\x64-windows\bin"
          if (Test-Path $VCPKG_BIN) {
              Copy-Item "$VCPKG_BIN\*.dll" $RELEASE_DIR -Force
          }
          
          $MSVC_REDIST = Get-ChildItem `
            "C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise\VC\Redist\MSVC" `
            -Directory | Sort-Object Name -Descending | Select-Object -First 1
          if ($MSVC_REDIST) {
              $CRT_PATH = Join-Path $MSVC_REDIST.FullName "x64\Microsoft.VC142.CRT"
              if (Test-Path $CRT_PATH) {
                  Copy-Item "$CRT_PATH\*.dll" $RELEASE_DIR -Force
              }
          }
          
          Copy-Item -Path "waffleCopyPRO-Universal/fonts" -Destination $RELEASE_DIR -Recurse
          Copy-Item -Path "waffleCopyPRO-Universal/WaffleUI" -Destination $RELEASE_DIR -Recurse
          Push-Location $RELEASE_DIR
          Compress-Archive -Path * -DestinationPath "../waffleCopyPRO-Universal-Windows.zip"
          Pop-Location

          # Create a simple PowerShell installer that installs the zip into Program Files and creates a Start Menu shortcut
          $installer = @'
          param()
          $zip = Join-Path $PSScriptRoot "waffleCopyPRO-Universal-Windows.zip"
          $dest = Join-Path $env:ProgramFiles "WaffleCopyPRO"
          if (-not (Test-Path $dest)) { New-Item -ItemType Directory -Path $dest -Force | Out-Null }
          Expand-Archive -Path $zip -DestinationPath $dest -Force
          $WshShell = New-Object -ComObject WScript.Shell
          $shortcutPath = Join-Path $env:ProgramData "Microsoft\Windows\Start Menu\Programs\WaffleCopyPRO.lnk"
          $shortcut = $WshShell.CreateShortcut($shortcutPath)
          $shortcut.TargetPath = Join-Path $dest "waffleCopyPRO-Universal.exe"
          $shortcut.WorkingDirectory = $dest
          $shortcut.Save()
          '@
          Set-Content -Path "waffleCopyPRO-Universal/Install-WaffleCopyPRO.ps1" -Value $installer -Encoding UTF8
        shell: pwsh

      - name: Create MSI (WiX)
        shell: pwsh
        run: |
          choco install wixtoolset --no-progress -y
          $RELEASE_DIR = "${{ github.workspace }}\waffleCopyPRO-Universal\release"
          $WIXBIN = Split-Path (Get-Command candle.exe).Source
          # Harvest files into a wxs fragment
          & "$WIXBIN\heat.exe" dir "$RELEASE_DIR" -cg APPFILES -dr INSTALLFOLDER -scom -sreg -sfrag -gg -srd -var var.ReleaseDir -out "$env:GITHUB_WORKSPACE\app.wxs"
          # Create product.wxs with a generated UpgradeCode
          $upgrade = [guid]::NewGuid().ToString()
          $product = @"
<?xml version='1.0' encoding='UTF-8'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
  <Product Id='*' Name='WaffleCopyPRO' Language='1033' Version='1.0.0.0' Manufacturer='Waffle' UpgradeCode='$upgrade'>
    <Package InstallerVersion='500' Compressed='yes' InstallScope='perMachine' />
    <MediaTemplate />
    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id='ProgramFilesFolder'>
        <Directory Id='INSTALLFOLDER' Name='WaffleCopyPRO' />
      </Directory>
    </Directory>
    <Feature Id='ProductFeature' Title='WaffleCopyPRO' Level='1'>
      <ComponentGroupRef Id='APPFILES'/>
    </Feature>
  </Product>
</Wix>
"@
          Set-Content -Path "$env:GITHUB_WORKSPACE\waffleCopyPRO-Universal\product.wxs" -Value $product -Encoding UTF8
          # Compile and link with WiX
          & "$WIXBIN\candle.exe" -dReleaseDir="$RELEASE_DIR" "$env:GITHUB_WORKSPACE\app.wxs" "$env:GITHUB_WORKSPACE\waffleCopyPRO-Universal\product.wxs" -out "$env:GITHUB_WORKSPACE\waffleCopyPRO-Universal\product.wixobj"
          & "$WIXBIN\light.exe" "$env:GITHUB_WORKSPACE\waffleCopyPRO-Universal\product.wixobj" -out "$env:GITHUB_WORKSPACE\waffleCopyPRO-Universal\waffleCopyPRO-Universal.msi"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: waffleCopyPRO-Universal-Windows
          path: |
            waffleCopyPRO-Universal/release/
            waffleCopyPRO-Universal/waffleCopyPRO-Universal-Windows.zip
            waffleCopyPRO-Universal/Install-WaffleCopyPRO.ps1
            waffleCopyPRO-Universal/waffleCopyPRO-Universal.msi

      - name: Create Release and Upload Asset
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            waffleCopyPRO-Universal/waffleCopyPRO-Universal-Windows.zip
            waffleCopyPRO-Universal/waffleCopyPRO-Universal.msi
          draft: false
          prerelease: false

